<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Profile + Events + Create Event Wizard + Listing/Payment</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  /* --- Page basics --- */
  :root { --primary: #0a67b2; --accent: #0f4c86; --bg: #cff2ff; --card:#fff; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: Arial, sans-serif; background: var(--bg); color:#083047; }

  /* Nav */
  nav { background: var(--primary); color:#fff; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:30; }
  nav .links a { color:#fff; text-decoration:none; margin-left:20px; font-size:15px; }

  /* Profile container */
  .profile-container { width:80%; background:#2d506b; color:#fff; margin:36px auto; padding:36px; border-radius:20px; display:flex; align-items:center; box-shadow:2px 6px 18px rgba(0,0,0,0.12); }
  .profile-image img { width:170px; height:170px; border-radius:50%; object-fit:cover; border:4px solid #fff; }
  .profile-info { margin-left:28px; flex:1; }
  .profile-info h1 { margin:0; font-size:36px; }
  .edit-profile { margin-left:auto; margin-top:80px; }
  .edit-profile a { color:#fff; text-decoration:none; border-bottom:1px solid #fff; cursor:pointer; }

  /* Events card */
  .event-card { width:80%; background:var(--card); margin:20px auto; padding:20px; border-radius:12px; box-shadow:2px 6px 16px rgba(0,0,0,0.08); }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:12px; border-bottom:1px solid #e6e6e6; text-align:left; }
  th { color:var(--primary); }
  .create-btn { text-align:right; margin-top:12px; }
  .create-btn button { background:var(--primary); color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }

  /* Map */
  #map { width:80%; height:480px; margin:30px auto; border-radius:12px; border:3px solid var(--primary); }

  /* Footer */
  footer { background:#08223b; color:#fff; padding:40px 60px; display:flex; gap:20px; justify-content:space-between; flex-wrap:wrap; margin-top:40px; }
  .footer-section { width:30%; min-width:200px; }
  .footer-title { font-weight:700; margin-bottom:10px; }
  .social-icons { display:flex; gap:12px; font-size:20px; }

  /* --- Wizard full-page layout (hidden by default) --- */
  .overlay-page { display:none; position:fixed; inset:0; background:rgba(207,242,255,0.95); z-index:60; overflow:auto; padding-bottom:60px; }
  .wizard-top { display:flex; align-items:center; justify-content:center; padding:28px 12px 6px; position:relative; }
  .wizard-back { position:absolute; left:24px; top:24px; font-size:22px; color:var(--primary); cursor:pointer; border:2px solid rgba(10,103,178,0.15); width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:transparent; }
  .wizard-title { font-size:26px; color:var(--primary); font-weight:700; }

  .wizard-body { display:flex; justify-content:center; }
  .wizard-card-wrap { width:760px; background:rgba(10,103,178,0.08); padding:36px; border-radius:12px; margin:22px; }
  .wizard-card { background:#fff; padding:22px; border-radius:8px; margin-bottom:12px; }
  .wizard-step-title { color:var(--primary); font-size:18px; font-weight:600; margin-bottom:12px; }
  .field { margin:10px 0; }
  .field label { display:block; font-size:13px; margin-bottom:6px; color:#2b4b66; }
  .field input[type="text"], .field input[type="date"], .field input[type="time"], .field textarea, .field select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d9e6f0; background:linear-gradient(#f6fbff,#ecf6ff); }
  .two-col { display:flex; gap:12px; }
  .two-col .col { flex:1; }

  .wizard-actions { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
  .wizard-actions .left { color:#0a67b2; }
  .wizard-actions button { background:var(--primary); color:#fff; border:none; padding:9px 14px; border-radius:8px; cursor:pointer; }

  /* mini-map inside wizard */
  #wizardMap { height:200px; border-radius:8px; margin-top:8px; }

  /* small image preview */
  .img-preview { width:110px; height:80px; object-fit:cover; border-radius:6px; border:1px solid #e6e6e6; }

  /* Listing + Payment pages (overlays inside same style) */
  .listing-grid { display:flex; gap:12px; flex-wrap:wrap; }
  .box { flex:1 1 160px; background: white; padding:18px; border-radius:12px; border: 2px solid #dfeaf2; text-align:center; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; }
  .box:hover { transform: translateY(-6px); box-shadow:0 8px 20px rgba(0,0,0,0.08); }
  .box.selected { border-color: #005bbb; box-shadow:0 10px 26px rgba(0,91,187,0.12); }

  .btn { display:inline-block; padding:10px 16px; background:var(--primary); color:#fff; border-radius:8px; border:none; cursor:pointer; }
  .btn.secondary { background:#fff; color:var(--primary); border:1px solid #d9e6f0; }

  /* Payment method tiles */
  .pay-method { display:flex; gap:10px; margin-top:10px; }
  .pm { flex:1; padding:12px; border:2px solid #dfeaf2; border-radius:8px; text-align:center; cursor:pointer; }
  .pm img { height:36px; display:block; margin:0 auto 6px; }
  .pm.pm-active { border-color:#005bbb; background:#e8f3ff; }

  /* popup success */
  .popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index:120; }
  .popup-box { width: 480px; background: #fff; padding: 22px; border-radius:10px; text-align:left; }

  /* responsive */
  @media (max-width:900px) {
    .wizard-card-wrap { width:92%; }
    #map { height:360px; }
    .two-col { flex-direction:column; }
    .listing-grid { flex-direction:column; }
    .box { width:100%; }
    .payment-container { flex-direction:column; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo">HanapGimik</div>
  <div class="links">
    <a href="#">Contact Us</a>
    <a href="AboutUs.html">About Us</a>
    <a href="LoginPage.html">Log Out</a>
  </div>
</nav>

<!-- PROFILE -->
<div id="profileView">
  <div class="profile-container">
    <div class="profile-image"><img id="profilePic" src="images/c.png" alt="Profile"></div>
    <div class="profile-info">
      <h1 id="nameText">Taylor Swift</h1>
      <p><strong>Age:</strong> <span id="ageText">35</span></p>
      <p><strong>Location:</strong> <span id="locationText">Bugo, Cagayan de Oro</span></p>
      <p><strong>Occupation:</strong> <span id="occupationText">Singer</span></p>
      <p><strong>Email:</strong> <span id="emailText">taylorswift@gmail.com</span></p>
    </div>
    <div class="edit-profile"><a id="editBtn">Edit Profile ‚úèÔ∏è</a></div>
  </div>

  <!-- ACCOUNT TYPE -->
  <div class="account-box" style="width:80%; margin:auto;">
    <p><strong>Account Type:</strong></p>
    <div class="account-type" style="background:#fff; width:260px; padding:12px; border-radius:8px; border:2px solid #c9c9c9;">Event Creator</div>
  </div>

  <!-- EVENTS -->
  <div class="event-card">
    <h2>My Events</h2>
    <table id="eventsTable">
      <thead>
        <tr><th>Event Name</th><th>Location</th><th>ID</th><th>Date Created</th><th>Event Date</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="create-btn"><button id="openWizardBtn" class="btn">Create an Event</button></div>
  </div>

  <!-- MAIN MAP -->
  <h2 style="text-align:center; color:#0f4c86;">üìç My Event Map (Bugo Trinitas)</h2>
  <div id="map"></div>

  <!-- Footer -->
  <footer>
    <div class="footer-section">
      <p class="footer-title">Socials:</p>
      <div class="social-icons"><i class="fab fa-facebook"></i><i class="fab fa-twitter"></i><i class="fab fa-instagram"></i></div>
    </div>
    <div class="footer-section">
      <p class="footer-title">Company:</p>
      <p>About Us</p><p>Contact Us</p><p>Career</p>
    </div>
    <div class="footer-section">
      <p class="footer-title">Further Information:</p>
      <p>Terms and Policies</p><p>Privacy and Safety</p>
    </div>
  </footer>
</div>

<!-- WIZARD: Step 1-3 overlay -->
<div id="wizardOverlay" class="overlay-page">
  <div class="wizard-top">
    <div id="wizardBackToProfile" class="wizard-back" title="Back to profile"><i class="fas fa-arrow-left"></i></div>
    <div class="wizard-title">Create an Event</div>
  </div>

  <div class="wizard-body">
    <div class="wizard-card-wrap">
      <!-- Step 1 -->
      <div class="wizard-card" id="step1">
        <div class="wizard-step-title">Basic Information</div>

        <div class="field">
          <label>Event Name:</label>
          <input type="text" id="evt_name" placeholder="Event name">
        </div>

        <div class="field">
          <label>Description:</label>
          <textarea id="evt_desc" rows="3" placeholder="Short description"></textarea>
        </div>

        <div class="two-col">
          <div class="col field">
            <label>Category:</label>
            <select id="evt_category"><option>Events</option><option>Sports</option><option>Music</option><option>Concert</option><option>Health</option></select>
          </div>
          <div class="col field">
            <label>Upload Image:</label>
            <div style="display:flex; gap:10px; align-items:center;">
              <input type="file" id="evt_image" accept="image/*">
              <img id="imgPreview" class="img-preview" alt="preview" style="display:none;">
            </div>
          </div>
        </div>

        <div class="wizard-actions">
          <div class="left"></div>
          <div>
            <button id="toStep2" class="btn">Next ‚ûú</button>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="wizard-card" id="step2" style="display:none;">
        <div class="wizard-step-title">Schedule and Location</div>

        <div class="field">
          <label>Location name (eg. Phase 1 Basketball Court):</label>
          <input type="text" id="evt_locname" placeholder="Location name or address">
        </div>

        <div class="field">
          <label>Date:</label>
          <input type="date" id="evt_date">
        </div>

        <div class="two-col">
          <div class="col field">
            <label>Start Time:</label>
            <input type="time" id="evt_start">
          </div>
          <div class="col field">
            <label>End Time:</label>
            <input type="time" id="evt_end">
          </div>
        </div>

        <div class="field">
          <label>Pick location on map (click to place marker):</label>
          <div id="wizardMap"></div>
        </div>

        <div class="wizard-actions">
          <div class="left"><button id="backTo1" class="btn secondary">‚óÇ Back</button></div>
          <div><button id="toStep3" class="btn">Next ‚ûú</button></div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="wizard-card" id="step3" style="display:none;">
        <div class="wizard-step-title">Organizer Information</div>

        <div class="field">
          <label>Name:</label>
          <input type="text" id="org_name" placeholder="Organizer name">
        </div>
        <div class="field">
          <label>Contact Number:</label>
          <input type="text" id="org_contact" placeholder="Contact number">
        </div>
        <div class="field">
          <label>Address:</label>
          <input type="text" id="org_address" placeholder="Organizer address">
        </div>

        <div class="wizard-actions">
          <div class="left"><button id="backTo2" class="btn secondary">‚óÇ Back</button></div>
          <div><button id="toListing" class="btn">Continue to Listing ‚ûú</button></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- LISTING overlay (after wizard step 3) -->
<div id="listingOverlay" class="overlay-page">
  <div class="wizard-top">
    <div id="listingBack" class="wizard-back" title="Back to wizard"><i class="fas fa-arrow-left"></i></div>
    <div class="wizard-title">Choose Listing Type</div>
  </div>

  <div class="wizard-body">
    <div class="wizard-card-wrap">
      <div class="wizard-card" id="listingCard">
        <div class="wizard-step-title">Listing Options</div>
        <div class="listing-grid" id="listingGrid">
          <div class="box" data-type="Basic" data-amount="200" data-desc="Listed for 7 days">
            <h3>‚Ç±200</h3><p>7 days</p><p>Listed in general section</p>
          </div>
          <div class="box" data-type="Featured" data-amount="800" data-desc="Shown for 30 days on homepage">
            <h3>‚Ç±800</h3><p>30 days</p><p>Maximum visibility</p>
          </div>
          <div class="box" data-type="Premium" data-amount="500" data-desc="Visible for 14 days">
            <h3>‚Ç±500</h3><p>14 days</p><p>Higher placement + exposure</p>
          </div>
          <div class="box" data-type="Custom" data-amount="30" data-desc="Charged per day">
            <h3>‚Ç±30</h3><p>per day</p><p>Custom duration</p>
          </div>
        </div>

        <div style="margin-top:14px; text-align:right;">
          <button id="listingToPayment" class="btn">Proceed to Payment ‚ûú</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT overlay -->
<div id="paymentOverlay" class="overlay-page">
  <div class="wizard-top">
    <div id="paymentBack" class="wizard-back" title="Back to listing"><i class="fas fa-arrow-left"></i></div>
    <div class="wizard-title">Payment</div>
  </div>

  <div class="wizard-body">
    <div class="wizard-card-wrap">
      <div class="wizard-card" id="paymentCard">
        <div class="wizard-step-title">Payment Summary</div>

        <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px; background:#f3fbff; padding:12px; border-radius:8px;">
            <p><b>Event Title:</b> <span id="sum_title"></span></p>
            <p><b>Category:</b> <span id="sum_category"></span></p>
            <p><b>Location:</b> <span id="sum_location"></span></p>
            <p><b>Event Date:</b> <span id="sum_date"></span></p>
            <hr>
            <p><b>Listing Type:</b> <span id="sum_type"></span></p>
            <p><b>Amount:</b> ‚Ç±<span id="sum_amount"></span></p>
          </div>

          <div style="flex:1; min-width:260px;">
            <div class="wizard-step-title">Choose Payment Method</div>
            <div class="pay-method" id="payMethods">
              <div class="pm" data-method="GCash">
                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..." alt="GCash" />
                <div>GCash</div>
              </div>
              <div class="pm" data-method="Maya">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="Maya" />
                <div>Maya</div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <input type="text" id="pay_owner" placeholder="GCash/Maya Owner Name" style="width:100%; padding:10px; border-radius:6px; border:1px solid #dbeaf6;">
              <input type="text" id="pay_contact" placeholder="Contact Number" style="width:100%; padding:10px; border-radius:6px; border:1px solid #dbeaf6; margin-top:8px;">
              <input type="text" id="pay_note" placeholder="Note (Optional)" style="width:100%; padding:10px; border-radius:6px; border:1px solid #dbeaf6; margin-top:8px;">
            </div>

            <div style="margin-top:14px; text-align:right;">
              <button id="finishPaymentBtn" class="btn">Proceed Payment</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="popup" class="popup">
  <div class="popup-box">
    <h3>Event Created Successfully!</h3>
    <p><b>Event Name:</b> <span id="popName"></span></p>
    <p><b>Event ID:</b> <span id="popID"></span></p>
    <p><b>Category:</b> <span id="popCat"></span></p>
    <p><b>Date & Time:</b> <span id="popDT"></span></p>
    <p><b>Location:</b> <span id="popLoc"></span></p>
    <hr>
    <p><b>Listing Type:</b> <span id="popList"></span></p>
    <p><b>Amount Paid:</b> ‚Ç±<span id="popAmt"></span></p>

    <div style="text-align:right; margin-top:12px;">
      <button class="btn" id="doneBtn">Done</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ----------------- Storage key ----------------- */
const EVENTS_KEY = 'hanapgimik_events';

/* ----------------- Helpers ----------------- */
function loadEvents(){ const raw = localStorage.getItem(EVENTS_KEY); return raw ? JSON.parse(raw) : []; }
function saveEvents(events){ localStorage.setItem(EVENTS_KEY, JSON.stringify(events)); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function genEventId(){ return 'EVT-' + Date.now().toString(36).toUpperCase().slice(-8); }

/* ----------------- MAIN MAP ----------------- */
const mainMap = L.map('map').setView([8.5046, 124.7683], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(mainMap);
const mainMarkers = L.layerGroup().addTo(mainMap);

function addMarkerToMainMap(lat, lng, title, note, imageDataUrl){
  const popup = `
    <b>${escapeHtml(title)}</b><br>
    <div style="min-height:40px;">${escapeHtml(note) || '<i>No description</i>'}</div>
    ${imageDataUrl ? `<br><img src="${imageDataUrl}" style="width:140px;border-radius:6px;margin-top:6px;">` : ''}
  `;
  L.marker([lat, lng]).addTo(mainMarkers).bindPopup(popup);
}

/* populate events table and markers */
function refreshEventsUI(){
  const events = loadEvents();
  const tbody = document.querySelector('#eventsTable tbody');
  tbody.innerHTML = '';
  events.forEach(ev => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(ev.name)}</td>
      <td>${escapeHtml(ev.locationName || (ev.lat+','+ev.lng))}</td>
      <td>${ev.id}</td>
      <td>${new Date(ev.createdAt).toLocaleString()}</td>
      <td>${ev.date || ''}</td>
    `;
    tbody.prepend(tr); // newest first
  });

  mainMarkers.clearLayers();
  events.forEach(ev => { if (ev.lat && ev.lng) addMarkerToMainMap(ev.lat, ev.lng, ev.name, ev.description, ev.imageDataUrl); });
}

/* initial */
refreshEventsUI();

/* ----------------- Wizard controls ----------------- */
const profileView = document.getElementById('profileView');
const wizardOverlay = document.getElementById('wizardOverlay');
const listingOverlay = document.getElementById('listingOverlay');
const paymentOverlay = document.getElementById('paymentOverlay');

document.getElementById('openWizardBtn').addEventListener('click', () => {
  profileView.style.display = 'none';
  wizardOverlay.style.display = 'block';
  showStep(1);
  window.scrollTo({top:0});
});
document.getElementById('wizardBackToProfile').addEventListener('click', () => {
  wizardOverlay.style.display = 'none';
  profileView.style.display = 'block';
});
document.getElementById('listingBack').addEventListener('click', ()=> {
  listingOverlay.style.display = 'none';
  wizardOverlay.style.display = 'block';
  showStep(3);
});
document.getElementById('paymentBack').addEventListener('click', ()=> {
  paymentOverlay.style.display = 'none';
  listingOverlay.style.display = 'block';
});

/* step navigation */
const step1El = document.getElementById('step1');
const step2El = document.getElementById('step2');
const step3El = document.getElementById('step3');

function showStep(n){
  step1El.style.display = n===1 ? 'block' : 'none';
  step2El.style.display = n===2 ? 'block' : 'none';
  step3El.style.display = n===3 ? 'block' : 'none';
}
document.getElementById('toStep2').addEventListener('click', () => {
  if (!document.getElementById('evt_name').value.trim()) { alert('Please enter event name.'); return; }
  showStep(2);
  window.scrollTo({top:0});
});
document.getElementById('backTo1').addEventListener('click', ()=> showStep(1));
document.getElementById('toStep3').addEventListener('click', () => {
  if (!document.getElementById('evt_date').value) { alert('Please pick a date.'); return; }
  showStep(3);
  window.scrollTo({top:0});
});
document.getElementById('backTo2').addEventListener('click', ()=> showStep(2));

/* ----------------- Wizard mini-map ----------------- */
const wizardMap = L.map('wizardMap', { attributionControl:false }).setView([8.5046,124.7683], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(wizardMap);
let wizardMarker = null;
wizardMap.on('click', (e) => {
  if (wizardMarker) wizardMap.removeLayer(wizardMarker);
  wizardMarker = L.marker(e.latlng, {draggable:true}).addTo(wizardMap);
});

/* mainMap quick click popup hint */
mainMap.on('click', (e) => {
  L.popup().setLatLng(e.latlng).setContent('Click Create Event to register this location in a new event.').openOn(mainMap);
});

/* ----------------- Image preview ----------------- */
const evtImageInput = document.getElementById('evt_image');
const imgPreview = document.getElementById('imgPreview');
let stagedImageDataUrl = null; // keep image (DataURL) until finally saved
evtImageInput.addEventListener('change', () => {
  const f = evtImageInput.files[0];
  if (!f) { imgPreview.style.display='none'; imgPreview.src=''; stagedImageDataUrl = null; return; }
  const r = new FileReader();
  r.onload = () => { imgPreview.src = r.result; imgPreview.style.display='block'; stagedImageDataUrl = r.result; };
  r.readAsDataURL(f);
});

/* ----------------- After Step3: go to listing overlay (collect event draft) ----------------- */
let eventDraft = null;
document.getElementById('toListing').addEventListener('click', () => {
  // collect and validate the wizard data
  const name = document.getElementById('evt_name').value.trim();
  const description = document.getElementById('evt_desc').value.trim();
  const category = document.getElementById('evt_category').value;
  const locationName = document.getElementById('evt_locname').value.trim();
  const date = document.getElementById('evt_date').value;
  const start = document.getElementById('evt_start').value;
  const end = document.getElementById('evt_end').value;
  const orgName = document.getElementById('org_name').value.trim();
  const orgContact = document.getElementById('org_contact').value.trim();
  const orgAddress = document.getElementById('org_address').value.trim();

  // require at least locationName or marker
  let lat = null, lng = null;
  if (wizardMarker) { const latlng = wizardMarker.getLatLng(); lat = latlng.lat; lng = latlng.lng; }
  if (!locationName && (!lat || !lng)) { alert('Please enter a location name or pick location on the map.'); return; }

  // store draft (image stays in stagedImageDataUrl)
  eventDraft = {
    name, description, category,
    locationName, date, start, end,
    lat, lng,
    imageDataUrl: stagedImageDataUrl,
    organizer: { name: orgName, contact: orgContact, address: orgAddress }
  };

  // show listing overlay
  wizardOverlay.style.display = 'none';
  listingOverlay.style.display = 'block';
  window.scrollTo({top:0});
});

/* ----------------- Listing selection ----------------- */
let selectedListing = null;
document.querySelectorAll('#listingGrid .box').forEach(b=>{
  b.addEventListener('click',(e)=>{
    document.querySelectorAll('#listingGrid .box').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    selectedListing = {
      type: b.dataset.type,
      amount: Number(b.dataset.amount),
      desc: b.dataset.desc
    };
  });
});

/* proceed to payment overlay; fill summary with draft data */
document.getElementById('listingToPayment').addEventListener('click', ()=>{
  if (!selectedListing) { alert('Please choose a listing type.'); return; }
  if (!eventDraft) { alert('Event data missing. Please re-create the event.'); return; }

  // fill payment summary fields
  document.getElementById('sum_title').innerText = eventDraft.name || '(no title)';
  document.getElementById('sum_category').innerText = eventDraft.category || '';
  document.getElementById('sum_location').innerText = eventDraft.locationName || `${eventDraft.lat},${eventDraft.lng}`;
  const dt = eventDraft.date ? `${eventDraft.date} ${eventDraft.start ? '- ' + eventDraft.start : ''} ${eventDraft.end ? ' to ' + eventDraft.end : ''}` : '';
  document.getElementById('sum_date').innerText = dt;
  document.getElementById('sum_type').innerText = selectedListing.type + ' (' + selectedListing.desc + ')';
  document.getElementById('sum_amount').innerText = selectedListing.amount.toFixed(2);

  // show payment overlay
  listingOverlay.style.display = 'none';
  paymentOverlay.style.display = 'block';
  window.scrollTo({top:0});
});

/* ----------------- Payment method pick ----------------- */
let selectedMethod = null;
document.querySelectorAll('#payMethods .pm').forEach(pm=>{
  pm.addEventListener('click', ()=>{
    document.querySelectorAll('#payMethods .pm').forEach(x=>x.classList.remove('pm-active'));
    pm.classList.add('pm-active');
    selectedMethod = pm.dataset.method;
  });
});

/* ----------------- Finalize payment -> save event and show success popup ----------------- */
document.getElementById('finishPaymentBtn').addEventListener('click', async ()=>{
  if (!selectedMethod) { alert('Please select a payment method.'); return; }
  const owner = document.getElementById('pay_owner').value.trim();
  const contact = document.getElementById('pay_contact').value.trim();
  // minimal validation
  if (!owner || !contact) { if(!confirm('Owner name or contact missing. Continue?')) return; }

  // create final event object
  const ev = {
    id: genEventId(),
    name: eventDraft.name,
    description: eventDraft.description,
    category: eventDraft.category,
    locationName: eventDraft.locationName,
    date: eventDraft.date,
    start: eventDraft.start,
    end: eventDraft.end,
    lat: eventDraft.lat,
    lng: eventDraft.lng,
    imageDataUrl: eventDraft.imageDataUrl,
    organizer: eventDraft.organizer,
    listing: { type: selectedListing.type, amount: selectedListing.amount, desc: selectedListing.desc },
    payment: { method: selectedMethod, owner, contact, note: document.getElementById('pay_note').value || '' },
    createdAt: new Date().toISOString()
  };

  // save (prepend)
  const events = loadEvents();
  events.unshift(ev);
  saveEvents(events);
  refreshEventsUI();

  // show popup summary (populate)
  document.getElementById('popName').innerText = ev.name;
  document.getElementById('popID').innerText = ev.id;
  document.getElementById('popCat').innerText = ev.category;
  document.getElementById('popDT').innerText = ev.date ? (ev.date + (ev.start ? ' | ' + ev.start + (ev.end ? ' - ' + ev.end : '') : '')) : '';
  document.getElementById('popLoc').innerText = ev.locationName || (ev.lat+','+ev.lng);
  document.getElementById('popList').innerText = ev.listing.type + ' (' + ev.listing.desc + ')';
  document.getElementById('popAmt').innerText = ev.listing.amount.toFixed(2);

  // close overlays and show popup
  paymentOverlay.style.display = 'none';
  listingOverlay.style.display = 'none';
  wizardOverlay.style.display = 'none';
  document.getElementById('popup').style.display = 'flex';

  // clear draft & UI fields for next create
  eventDraft = null;
  selectedListing = null;
  selectedMethod = null;
  stagedImageDataUrl = null;
  document.getElementById('evt_image').value = '';
  imgPreview.style.display='none';
  document.getElementById('pay_owner').value=''; document.getElementById('pay_contact').value=''; document.getElementById('pay_note').value='';
});

/* Done button in popup */
document.getElementById('doneBtn').addEventListener('click', ()=>{
  document.getElementById('popup').style.display = 'none';
  profileView.style.display = 'block';
  // center map to latest event if exists
  const events = loadEvents();
  if (events.length && events[0].lat && events[0].lng) mainMap.setView([events[0].lat, events[0].lng], 16);
});

/* ----------------- Simple inline edit profile (prompt) ----------------- */
document.getElementById('editBtn').addEventListener('click', () => {
  const newName = prompt('Full name:', document.getElementById('nameText').innerText);
  if (newName) document.getElementById('nameText').innerText = newName;
  const newAge = prompt('Age:', document.getElementById('ageText').innerText);
  if (newAge) document.getElementById('ageText').innerText = newAge;
});

/* ----------------- Startup: ensure overlays hidden and tmp state reset ----------------- */
(function initState(){
  wizardOverlay.style.display = 'none';
  listingOverlay.style.display = 'none';
  paymentOverlay.style.display = 'none';
  document.getElementById('popup').style.display = 'none';
})();
</script>
</body>
</html>
